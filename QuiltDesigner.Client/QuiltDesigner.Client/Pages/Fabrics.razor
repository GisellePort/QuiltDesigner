@page "/fabrics"
@using QuiltDesigner.Shared.Models
@using QuiltDesigner.Core.Services
@using Microsoft.AspNetCore.Components.Forms
@inject FabricService FabricService

<h3>Fabric Manager</h3>

<p>Upload your fabric images below. They will appear in the list once uploaded.</p>

<!-- Proper Blazor InputFile component -->
<InputFile OnChange="UploadFabric" Multiple accept="image/*" />

<!-- Show all uploaded fabrics -->
<ul style="list-style-type:none; padding-left:0;">
    @foreach (var fabric in fabricList)
    {
        <li style="margin-bottom:15px; border:1px solid #ccc; padding:5px; display:flex; align-items:center;">
            <img src="@fabric.ImageDataUrl" width="80" height="80" style="object-fit:cover; margin-right:10px;" />
            <div>
                <strong>@fabric.Name</strong><br />
                @if (!string.IsNullOrEmpty(fabric.Notes))
                {
                    <em>@fabric.Notes</em>
                }
            </div>
        </li>
    }
</ul>

@code {
    private List<Fabric> fabricList = new();

    protected override void OnInitialized()
    {
        fabricList = FabricService.GetAllFabrics();
    }

    private async Task UploadFabric(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            // Read file into byte array
            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 10).ReadAsync(buffer); // 10MB limit

            // Convert to Base64 string for display
            var dataUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";

            var fabric = new Fabric
            {
                Name = file.Name,
                ImageDataUrl = dataUrl
            };

            FabricService.AddFabric(fabric);
        }

        fabricList = FabricService.GetAllFabrics();
        StateHasChanged();
    }
}
